<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë„ê° ë°ì´í„° íŒ©í† ë¦¬</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: #fff; display: flex; height: 100vh; margin: 0; }
        .image-panel { flex: 1; display: flex; justify-content: center; align-items: center; background: #1e1e1e; border-right: 2px solid #333; padding: 2rem; position: relative; }
        .image-panel img { max-width: 100%; max-height: 90vh; border-radius: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .form-panel { width: 500px; padding: 2rem; overflow-y: auto; background: #222; }
        h2 { color: #eab308; border-bottom: 1px solid #444; padding-bottom: 1rem; margin-top: 0; }
        .form-group { margin-bottom: 1.5rem; background: #2a2a2a; padding: 1rem; border-radius: 6px;}
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #ccc; font-size: 0.9rem;}
        input[type="text"], input[type="date"], select { width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
        .checkbox-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; }
        button { padding: 1rem; color: #000; font-weight: bold; font-size: 1rem; border: none; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .btn-save { background: #eab308; flex: 2; }
        .btn-save:hover { background: #ca8a04; }
        .btn-delete { background: #dc2626; color: #fff; flex: 1; }
        .btn-delete:hover { background: #b91c1c; }
        .skill-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .skill-inputs { display: flex; gap: 0.3rem; }
        .kw-badge { display: inline-flex; align-items: center; background: #444; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; color: #fff; font-size: 0.85rem; margin-bottom: 0.3rem;}
        .kw-badge input { margin-right: 0.4rem; }
        
        /* ğŸš€ ìƒˆë¡œ ì¶”ê°€ëœ ì»¤ìŠ¤í…€ ê²€ìƒ‰ì°½ ë””ìì¸ */
        .search-item { padding: 0.6rem 0.8rem; border-bottom: 1px solid #333; cursor: pointer; font-size: 0.9rem; color: #ccc; transition: 0.1s; }
        .search-item:hover { background: #eab308; color: #000; font-weight: bold; }
        .search-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="image-panel">
        <img src="/images/{{ image }}" alt="ìˆ˜ê°ì ì´ë¯¸ì§€">
    </div>

    <div class="form-panel">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <a href="/scraper" style="color: #eab308; text-decoration: none; font-size: 0.85rem;">ğŸ” ìˆ˜ì§‘ê¸° ê°€ê¸°</a>
            <a href="/cleanup" style="color: #ef4444; text-decoration: none; font-size: 0.85rem;" onclick="return confirm('ì°Œêº¼ê¸° ë°ì´í„°ë¥¼ ì²­ì†Œí• ê¹Œìš”?');">ğŸ§¹ ë°ì´í„° ë¬´ê²°ì„± ê²€ì‚¬</a>
        </div>

        <div style="display: flex; gap: 0.8rem; margin-bottom: 1.5rem; background: #2a2a2a; padding: 1rem; border-radius: 6px; align-items: center;">
            <a href="{% if page > 0 %}/?page={{ page - 1 }}{% else %}#{% endif %}" 
               style="text-decoration: none; padding: 0.5rem 0.8rem; background: #444; color: {% if page > 0 %}#fff{% else %}#666{% endif %}; border-radius: 4px; pointer-events: {% if page > 0 %}auto{% else %}none{% endif %}; font-size: 0.9rem; white-space: nowrap;">
               â—€ ì´ì „
            </a>
            
            <div style="flex: 1; position: relative;">
                <input type="text" id="custom_search_input" placeholder="ğŸ” í´ë¦­í•˜ì—¬ ì „ì²´ë³´ê¸° ë˜ëŠ” íƒ€ì ì³ì„œ ê²€ìƒ‰..." 
                       style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box;"
                       autocomplete="off">
                
                <div id="custom_search_dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #1e1e1e; border: 1px solid #444; max-height: 250px; overflow-y: auto; z-index: 1000; border-radius: 0 0 4px 4px; box-shadow: 0 10px 20px rgba(0,0,0,0.8);">
                    {% for item in search_list %}
                    <div class="search-item" data-page="{{ item.page }}">
                        {{ item.page + 1 }}. {{ item.name }}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div style="color: #888; font-weight: bold; white-space: nowrap; font-size: 0.9rem;">{{ page + 1 }} / {{ total }}</div>
        </div>

        <h2>ë°ì´í„° ì…ë ¥</h2>
        
        {% set s = data.get('skills', {}) %}
        {% set d = data.get('defense', {}) %}

        <form action="/save" method="POST">
            <input type="hidden" name="char_id" value="{{ char_id }}">
            <input type="hidden" name="page" value="{{ page }}">
            <input type="hidden" name="img_filename" value="{{ image }}">

            <div class="form-group">
                <label>ìˆ˜ê°ì ì´ë¦„</label>
                <select name="characterName" required>
                    <option value="">-- ì„ íƒ --</option>
                    {% for name in ['ì´ìƒ', 'íŒŒìš°ìŠ¤íŠ¸', 'ëˆí‚¤í˜¸í…Œ', 'ë£ŒìŠˆ', 'ë«¼ë¥´ì†Œ', 'í™ë£¨', 'íˆìŠ¤í´ë¦¬í”„', 'ì´ìŠ¤ë§ˆì—˜', 'ë¡œìŸˆ', 'ì‹±í´ë ˆì–´', 'ì˜¤í‹°ìŠ¤', 'ê·¸ë ˆê³ ë¥´'] %}
                    <option value="{{ name }}" {% if data.characterName == name %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>ì¸ê²© ì´ë¦„ (ì˜ˆ: Wì‚¬ ì •ë¦¬ìš”ì›)</label>
                <input type="text" name="identityName" value="{{ data.identityName or '' }}" required>
            </div>

            <div class="form-group skill-grid">
                <div>
                    <label>ì¸ê²© ë“±ê¸‰</label>
                    <select name="grade" required>
                        <option value="1" {% if data.grade == 1 %}selected{% endif %}>1ì„± (0)</option>
                        <option value="2" {% if data.grade == 2 %}selected{% endif %}>2ì„± (00)</option>
                        <option value="3" {% if data.grade == 3 %}selected{% endif %}>3ì„± (000)</option>
                    </select>
                </div>
                <div>
                    <label>ì¶œì‹œ ë‚ ì§œ</label>
                    <input type="date" name="releaseDate" value="{{ data.releaseDate or '' }}" required>
                </div>
            </div>

            <div class="form-group">
                <label style="color: #eab308;">ì´ë¯¸ì§€ ê¸°ì¤€ì  (ì–¼êµ´ ìœ„ì¹˜)</label>
                <select name="imagePosition">
                    <option value="left" {% if data.imagePosition == 'left' %}selected{% endif %}>ì™¼ìª½</option>
                    <option value="center" {% if data.imagePosition == 'center' or not data.imagePosition %}selected{% endif %}>ê°€ìš´ë° (ê¸°ë³¸)</option>
                    <option value="right" {% if data.imagePosition == 'right' %}selected{% endif %}>ì˜¤ë¥¸ìª½</option>
                </select>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" name="isDefault" id="isDefault" {% if data.isDefault %}checked{% endif %}>
                <label for="isDefault" style="color: #eab308; margin:0; cursor: pointer;">ê¸°ë³¸ ì¸ê²©ìœ¼ë¡œ ì„¤ì • (ë©”ì¸ ë…¸ì¶œ)</label>
            </div>

            <div class="form-group">
                <label>ì†Œì† (ì—¬ëŸ¬ ê°œë©´ ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                <input type="text" name="affiliation" placeholder="ì˜ˆ: ë¦¼ë²„ìŠ¤ ì»´í¼ë‹ˆ, Wì‚¬" value="{{ data.affiliation | join(', ') if data.affiliation is iterable and data.affiliation is not string else (data.affiliation or 'ë¦¼ë²„ìŠ¤ ì»´í¼ë‹ˆ') }}">
            </div>

            <div class="form-group">
                <label>í‚¤ì›Œë“œ ì„ íƒ ë° ì…ë ¥</label>
                <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 0.8rem;">
                    {% set common_keywords = ['í™”ìƒ', 'ì¶œí˜ˆ', 'ì§„ë™', 'íŒŒì—´', 'ì¹¨ì ', 'í˜¸í¡', 'ì¶©ì „'] %}
                    {% for kw in common_keywords %}
                    <label class="kw-badge">
                        <input type="checkbox" name="keywords_check" value="{{ kw }}" {% if data.keywords and kw in data.keywords %}checked{% endif %}> {{ kw }}
                    </label>
                    {% endfor %}
                </div>
                
                {% set manual_kws = [] %}
                {% if data.keywords %}
                    {% for k in data.keywords %}
                        {% if k not in common_keywords %}
                            {% set _ = manual_kws.append(k) %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
                <input type="text" name="manual_keywords" placeholder="íŠ¹ìˆ˜ í‚¤ì›Œë“œ ì§ì ‘ ì…ë ¥ (ì‰¼í‘œë¡œ êµ¬ë¶„)" value="{{ manual_kws | join(', ') }}">
            </div>

            <div class="form-group">
                <label>ìˆ˜ë¹„ ìŠ¤í‚¬</label>
                <div class="skill-inputs">
                    <select name="defense_type">
                        <option value="ê°€ë“œ" {% if d.get('type') == 'ê°€ë“œ' %}selected{% endif %}>ê°€ë“œ</option>
                        <option value="íšŒí”¼" {% if d.get('type') == 'íšŒí”¼' %}selected{% endif %}>íšŒí”¼</option>
                        <option value="ë°˜ê²©" {% if d.get('type') == 'ë°˜ê²©' %}selected{% endif %}>ë°˜ê²©</option>
                    </select>
                    <select name="defense_attr">
                        {% for attr in ['ì—†ìŒ', 'ë¶„ë…¸', 'ìƒ‰ìš•', 'ë‚˜íƒœ', 'íƒì‹', 'ìš°ìš¸', 'ì˜¤ë§Œ', 'ì§ˆíˆ¬'] %}
                        <option value="{{ attr }}" {% if d.get('attribute') == attr %}selected{% endif %}>{{ attr }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label style="color: #eab308; margin-bottom: 1rem;">ìŠ¤í‚¬ ì •ë³´ (ìœ í˜• + ì£„ì•… ì†ì„±)</label>
                <div class="skill-grid">
                    {% for i in range(1, 4) %}
                    {% set sk = s.get('skill' ~ i, {}) %}
                    <div>
                        <label>{{ i }}ìŠ¤í‚¬</label>
                        <div class="skill-inputs">
                            <select name="skill{{ i }}_type">
                                {% for type in ['ì°¸ê²©', 'ê´€í†µ', 'íƒ€ê²©'] %}
                                <option value="{{ type }}" {% if sk.get('type') == type %}selected{% endif %}>{{ type }}</option>
                                {% endfor %}
                            </select>
                            <select name="skill{{ i }}_attr">
                                {% for attr in ['ë¶„ë…¸', 'ìƒ‰ìš•', 'ë‚˜íƒœ', 'íƒì‹', 'ìš°ìš¸', 'ì˜¤ë§Œ', 'ì§ˆíˆ¬'] %}
                                <option value="{{ attr }}" {% if sk.get('attribute') == attr %}selected{% endif %}>{{ attr }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    {% set sp = s.get('special' ~ i, {}) %}
                    <div>
                        <label>íŠ¹ìˆ˜ {{ i }}ìŠ¤í‚¬</label>
                        <div class="skill-inputs">
                            <select name="special{{ i }}_type">
                                {% for type in ['ì—†ìŒ', 'ì°¸ê²©', 'ê´€í†µ', 'íƒ€ê²©'] %}
                                <option value="{{ type }}" {% if sp.get('type') == type %}selected{% endif %}>{{ type }}</option>
                                {% endfor %}
                            </select>
                            <select name="special{{ i }}_attr">
                                {% for attr in ['ì—†ìŒ', 'ë¶„ë…¸', 'ìƒ‰ìš•', 'ë‚˜íƒœ', 'íƒì‹', 'ìš°ìš¸', 'ì˜¤ë§Œ', 'ì§ˆíˆ¬'] %}
                                <option value="{{ attr }}" {% if sp.get('attribute') == attr %}selected{% endif %}>{{ attr }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn-save">ì €ì¥ ë° ë‹¤ìŒ ì´ë¯¸ì§€ â”</button>
                <button type="button" class="btn-delete" onclick="if(confirm('ì •ë§ ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)')) document.getElementById('delete-form').submit();">ì‚­ì œ ğŸ—‘ï¸</button>
            </div>
        </form>

        <form id="delete-form" action="/delete" method="POST" style="display:none;">
            <input type="hidden" name="img_filename" value="{{ image }}">
            <input type="hidden" name="char_id" value="{{ char_id }}">
            <input type="hidden" name="page" value="{{ page }}">
        </form>
    </div>

    <script>
        const searchInput = document.getElementById('custom_search_input');
        const searchDropdown = document.getElementById('custom_search_dropdown');
        const searchItems = document.querySelectorAll('.search-item');

        // 1. ê²€ìƒ‰ì°½ í´ë¦­ ì‹œ ì „ì²´ ëª©ë¡ì„ ì˜ˆì˜ê²Œ í¼ì¹¨
        searchInput.addEventListener('focus', () => {
            searchDropdown.style.display = 'block';
            searchInput.value = ''; // íƒ€ì´í•‘ ì¤€ë¹„
            searchInput.style.borderColor = '#eab308';
            searchItems.forEach(item => item.style.display = 'block');
        });

        // 2. íƒ€ì´í•‘í•  ë•Œë§ˆë‹¤ ëª©ë¡ ì‹¤ì‹œê°„ í•„í„°ë§
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            searchDropdown.style.display = 'block'; 
            searchItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(term)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // 3. ëª©ë¡ ì¤‘ í•˜ë‚˜ë¥¼ í´ë¦­í•˜ë©´ ì¦‰ì‹œ í•´ë‹¹ í˜ì´ì§€ë¡œ ì´ë™
        searchItems.forEach(item => {
            // mousedownì„ ì¨ì•¼ ê²€ìƒ‰ì°½ focus í•´ì œ(blur)ë³´ë‹¤ ë¨¼ì € í´ë¦­ì´ ì¸ì‹ë¨
            item.addEventListener('mousedown', () => { 
                const page = item.getAttribute('data-page');
                window.location.href = '/?page=' + page;
            });
        });

        // 4. ê²€ìƒ‰ì°½ ë°”ê¹¥ì„ ëˆ„ë¥´ë©´ ëª©ë¡ ë‹«ê¸°
        searchInput.addEventListener('blur', () => {
            searchDropdown.style.display = 'none';
            searchInput.style.borderColor = '#444';
        });
    </script>
</body>
</html>