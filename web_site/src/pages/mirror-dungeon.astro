---
// web_site/src/pages/mirror-dungeon.astro
import { getCollection } from 'astro:content';
import SinnerGroup from '../components/SinnerGroup.astro';

const allCharacters = await getCollection('characters');

const sinnerNames = [
  'ì´ìƒ', 'íŒŒìš°ìŠ¤íŠ¸', 'ëˆí‚¤í˜¸í…Œ', 'ë£ŒìŠˆ', 'ë«¼ë¥´ì†Œ', 'í™ë£¨', 
  'íˆìŠ¤í´ë¦¬í”„', 'ì´ìŠ¤ë§ˆì—˜', 'ë¡œìŸˆ', 'ì‹±í´ë ˆì–´', 'ì˜¤í‹°ìŠ¤', 'ê·¸ë ˆê³ ë¥´'
];

const groupedCharacters = sinnerNames.map(name => {
  let identities = allCharacters.filter(c => c.data.characterName === name);
  
  identities.sort((a, b) => {
    if (b.data.grade !== a.data.grade) return b.data.grade - a.data.grade;
    return new Date(b.data.releaseDate).getTime() - new Date(a.data.releaseDate).getTime();
  });

  return { name, identities };
});
---

<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ê±°ìš¸ë˜ì „ | ê±°ìš¸ë˜ì „ ë©˜í—¤ë¼</title>
    <style>
      body {
        margin: 0; font-family: 'Pretendard', sans-serif;
        background-color: #0a0a0a; color: #f5f5f5;
        display: flex; flex-direction: column; min-height: 100vh;
      }
      
      .logo-wrapper {
        display: flex; align-items: center; gap: 0.8rem;
        text-decoration: none;
      }
      .logo-img {
        height: 40px; 
        width: auto;
        border-radius: 50%; 
        box-shadow: 0 0 10px rgba(234, 179, 8, 0.5);
      }
      .logo-text {
        color: #eab308; font-size: 1.5rem; font-weight: 900;
        letter-spacing: 1px;
      }

      .top-nav {
        background: #111; border-bottom: 1px solid #333;
        padding: 1rem 2rem; display: flex; align-items: center;
      }

      .container { 
        max-width: 1800px; 
        margin: 0 auto; padding: 2rem 1.5rem; flex: 1; width: 100%; box-sizing: border-box;
      }
      .page-title { text-align: center; color: #fff; font-size: 2rem; margin-bottom: 0.5rem; }
      .page-subtitle { text-align: center; color: #888; margin-bottom: 2rem; }
      
      /* ğŸš€ ìœ„ì•„ë˜ë¡œ ë°°ì¹˜ë˜ëŠ” ë©”ì¸ ë ˆì´ì•„ì›ƒ */
      .main-layout {
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      /* ğŸš€ ìƒë‹¨: ë± í˜„í™©íŒ ëŒ€ì‹œë³´ë“œ (ìŠ¤í¬ë¡¤ ê³ ì •) */
      .deck-summary-area {
        width: 100%;
        position: sticky;
        top: 0;
        z-index: 100;
        background: rgba(17, 17, 17, 0.95);
        backdrop-filter: blur(8px);
        padding: 1.5rem;
        border-radius: 16px;
        border: 1px solid #333;
        border-bottom: 2px solid #eab308;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      }

      /* ğŸš€ í•˜ë‹¨: ìºë¦­í„° ëª©ë¡ ì˜ì—­ */
      .character-list-area {
        width: 100%;
      }

      /* ğŸš€ ì‹œì›í•œ 6ì¹¸ ê½‰ ì±„ìš°ê¸° í™©ê¸ˆë¹„ìœ¨! */
      .character-grid {
        display: grid; 
        grid-template-columns: repeat(6, 1fr); 
        gap: 1.5rem; 
      }

      /* ë°˜ì‘í˜•: í™”ë©´ì´ ì‘ì•„ì§€ë©´ ì¹´ë“œ ì¹¸ ìˆ˜ ì¡°ì ˆ */
      @media (max-width: 1600px) { .character-grid { grid-template-columns: repeat(5, 1fr); } }
      @media (max-width: 1300px) { .character-grid { grid-template-columns: repeat(4, 1fr); } }
      @media (max-width: 1000px) { .character-grid { grid-template-columns: repeat(3, 1fr); } }
      @media (max-width: 700px) { .character-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem; } }

      .empty-slot {
        display: flex; flex-direction: column; gap: 1rem;
        background: #151515; padding: 1.2rem;
        border-radius: 12px; border: 1px dashed #444;
      }
      .empty-slot h3 { margin: 0; color: #555; font-size: 1.3rem; border-bottom: 2px solid #222; padding-bottom: 0.5rem;}
      .empty-box {
        flex: 1; display: flex; justify-content: center; align-items: center;
        background: #0f0f0f; border-radius: 8px; color: #444; font-weight: bold; min-height: 350px; text-align: center;
      }

      /* í‘¸í„° ë””ìì¸ (ì´ ë¶€ë¶„ì€ ê±´ë“œë¦¬ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤!) */
      .site-footer { 
        background: #0a0a0a; border-top: 1px solid #222; padding: 3rem 2rem; margin-top: 4rem; color: #888;
      }
      .footer-content {
        max-width: 1400px; margin: 0 auto; display: flex; flex-direction: column; gap: 0.4rem; text-align: left;
      }
      .footer-title { color: #eab308; font-size: 1.2rem; margin: 0 0 0.5rem 0; }
      .site-footer p { margin: 0; font-size: 0.85rem; line-height: 1.6; }
      .contact-info a { color: #aaa; text-decoration: underline; }
      .contact-info a:hover { color: #eab308; }
      .copyright { margin-top: 1.5rem !important; }
      .version-info { margin-top: 1rem; border-top: 1px solid #222; padding-top: 1rem; }

      /* ğŸš€ ìš”ê¸° ì•„ë˜ 4ì¤„ë§Œ :global() ì´ ì”Œì›Œì¡ŒìŠµë‹ˆë‹¤! */
      :global(.support-panel) { flex: 1; text-align: center; padding-left: 1rem; position: relative; cursor: pointer; }
      :global(.support-panel:hover .support-tooltip) { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
      :global(.support-tooltip) { visibility: hidden; opacity: 0; position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(-10px); margin-top: 1.5rem; background: #151515; border: 1px solid #444; border-radius: 8px; padding: 1.2rem; width: max-content; min-width: 250px; box-shadow: 0 10px 30px rgba(0,0,0,0.9); transition: all 0.2s ease-out; z-index: 200; text-align: left; }
      :global(.support-tooltip::before) { content: ''; position: absolute; top: -6px; left: 50%; transform: translateX(-50%) rotate(45deg); width: 12px; height: 12px; background: #151515; border-top: 1px solid #444; border-left: 1px solid #444; }
    </style>
  </head>
  <body>
    <header class="top-nav">
      <a href="/" class="logo-wrapper">
        <img src="/logo.png" alt="ë¡œê³ " class="logo-img" />
        <span class="logo-text">ê±°ìš¸ë˜ì „ ë©˜í—¤ë¼</span>
      </a>
    </header>

    <div class="container">
      <h1 class="page-title">ê±°ìš¸ë˜ì „ í¸ì„±</h1>
      <p class="page-subtitle">ìˆ˜ì§‘ëœ ì´ ì¸ê²© ë°ì´í„°: {allCharacters.length}ê°œ</p>
      
      <div class="main-layout">
        
        <div class="deck-summary-area">
          <div id="deck-status">
            <p style="color: #888; text-align: center; margin: 0; font-size: 1.1rem;">
              ìˆ˜ê°ì ì¹´ë“œë¥¼ <b style="color:#eab308;">ìš°í´ë¦­</b>í•˜ì—¬ ìˆœì„œëŒ€ë¡œ í¸ì„±í•´ ì£¼ì„¸ìš”.
            </p>
          </div>
        </div>

        <div class="character-list-area">
          <div class="character-grid">
            {groupedCharacters.map(group => (
              group.identities.length > 0 ? (
                <SinnerGroup name={group.name} identities={group.identities} />
              ) : (
                <div class="empty-slot">
                  <h3>{group.name}</h3>
                  <div class="empty-box">ë°ì´í„°<br>ìˆ˜ì§‘ ì¤‘...</div>
                </div>
              )
            ))}
          </div>
        </div>

      </div>
    </div>

    <footer class="site-footer">
      <div class="footer-content">
        <h2 class="footer-title">ê±°ìš¸ë˜ì „ ë©˜í—¤ë¼</h2>
        <p>ë¦¼ë²„ìŠ¤ ì»´í¼ë‹ˆ ë¹„ê³µì‹ ìˆ˜ê°ì ë„ê° ë° í¸ì„± ì‹œë®¬ë ˆì´í„°ì…ë‹ˆë‹¤.</p>
        <p>ë¬¸ì˜ì‚¬í•­ì´ë‚˜ ë²„ê·¸ ì œë³´ëŠ” ì•„ë˜ ì´ë©”ì¼ë¡œ ì—°ë½í•´ì£¼ì„¸ìš”.</p>
        <p class="contact-info">Email: [ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥ ì˜ˆì •]</p>
        
        <p class="copyright">Â© 2026 ê±°ìš¸ë˜ì „ ë©˜í—¤ë¼</p>
        
        <div class="version-info">
          <p>2026.02.28 Ver.Astro 0.1.0-prototype</p>
          <p>ê±°ìš¸ë˜ì „ ë©˜í—¤ë¼ëŠ” í”„ë¡œì íŠ¸ë¬¸ ê³µì‹ ì„œë¹„ìŠ¤ê°€ ì•„ë‹ˆë©°, ì‚¬ìš©ëœ ëª¨ë“  ê²Œì„ ì•„íŠ¸ì›Œí¬, ì •ë³´, ì• ì…‹ì˜ ê¶Œë¦¬ì™€ ì €ì‘ê¶Œì€ í•´ë‹¹ ì €ì‘ê¶Œì(<b>Project Moon</b>)ì˜ ì†Œìœ ì…ë‹ˆë‹¤.</p>
        </div>
      </div>
    </footer>

    <script>
      let deck = [];

      document.addEventListener('DOMContentLoaded', () => {
        // 1. ìš°í´ë¦­ ì‹œ ë±ì— ë„£ê³  ë¹¼ê¸°
        document.addEventListener('contextmenu', (e) => {
          const container = e.target.closest('.cards-container');
          if (!container) return;
          
          e.preventDefault(); 

          const sinnerGroup = container.closest('.sinner-group');
          const sinnerName = sinnerGroup.getAttribute('data-sinner');

          const index = deck.indexOf(sinnerName);
          if (index > -1) {
            deck.splice(index, 1); // ì´ë¯¸ ìˆìœ¼ë©´ ëºŒ
          } else {
            if (deck.length >= 12) {
              alert("ê±°ìš¸ë˜ì „ í¸ì„±ì€ ìµœëŒ€ 12ëª…ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
              return;
            }
            deck.push(sinnerName); // ì—†ìœ¼ë©´ ë„£ìŒ
          }

          updateDeckUI();
        });

        // 2. ëˆ„êµ°ê°€ íŒì—…ì—ì„œ ì¸ê²©ì„ ë°”ê¾¸ë©´ ì¦‰ì‹œ í˜„í™©íŒ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        document.addEventListener('deck-updated', () => {
          updateDeckUI();
        });
      });

      // ğŸ”„ UI ì—…ë°ì´íŠ¸ ì—”ì§„ (ëˆ„ì  í•©ê³„ & íˆ´íŒ ì§€ì›)
      function updateDeckUI() {
        const statusDiv = document.getElementById('deck-status');
        let activeKeywords = {}; 
        let cumulativeKeywords = {}; 
        let tooltipHTML = ''; 

        const renderKeywords = (kwObj, alignCenter = false) => {
          let html = `<div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: ${alignCenter ? 'center' : 'flex-start'};">`;
          const entries = Object.entries(kwObj).sort((a, b) => b[1] - a[1]);
          if (entries.length === 0) return '<span style="color:#555; font-size:0.9rem;">ë³´ìœ  í‚¤ì›Œë“œ ì—†ìŒ</span>';
          
          entries.forEach(([kw, count]) => {
            html += `<span style="background: #222; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.9rem; border: 1px solid #444; color: #eee;">${kw} <b style="color:#eab308; margin-left:0.3rem;">${count}</b></span>`;
          });
          html += '</div>';
          return html;
        };

        document.querySelectorAll('.deck-order-badge').forEach(badge => badge.classList.add('hidden'));

        if (deck.length === 0) {
          statusDiv.innerHTML = '<p style="color: #888; text-align: center; margin: 0; font-size: 1.1rem;">ìˆ˜ê°ì ì¹´ë“œë¥¼ <b style="color:#eab308;">ìš°í´ë¦­</b>í•˜ì—¬ ìˆœì„œëŒ€ë¡œ í¸ì„±í•´ ì£¼ì„¸ìš”.</p>';
          return;
        }

        deck.forEach((sinnerName, index) => {
          const order = index + 1;
          const isSupport = order > 7;

          const groupElement = document.querySelector(`.sinner-group[data-sinner="${sinnerName}"]`);
          if (!groupElement) return;

          const badge = groupElement.querySelector('.deck-order-badge');
          if (badge) {
            badge.innerText = order;
            badge.classList.remove('hidden');
            badge.style.background = isSupport ? '#555' : '#eab308';
            badge.style.color = isSupport ? '#ccc' : '#000';
          }

          const activeCard = groupElement.querySelector('.card-wrapper.active');
          if (activeCard) {
            const keywordsStr = activeCard.getAttribute('data-keywords');
            if (keywordsStr) {
              const keywords = keywordsStr.split(',').filter(k => k.trim() !== '');
              keywords.forEach(kw => {
                cumulativeKeywords[kw] = (cumulativeKeywords[kw] || 0) + 1; 
                if (order <= 7) {
                  activeKeywords[kw] = (activeKeywords[kw] || 0) + 1; 
                }
              });
            }
          }

          if (order >= 8) {
            tooltipHTML += `
              <div style="margin-bottom: 1rem; border-bottom: 1px solid #333; padding-bottom: 0.8rem;">
                <div style="color: #ccc; font-size: 0.9rem; margin-bottom: 0.5rem;">
                  <b style="color:#eab308;">${order}ëª…</b> í¸ì„± ì‹œ <span style="color:#666; font-size:0.75rem;">(1~${order}ë²ˆ ëˆ„ì  í•©ê³„)</span>
                </div>
                ${renderKeywords(cumulativeKeywords, false)}
              </div>
            `;
          }
        });

        let finalHTML = `
          <div style="display: flex; width: 100%; justify-content: center; align-items: flex-start; gap: 1rem;">
            <div style="flex: 1; text-align: center; border-right: 1px solid #333; padding-right: 1rem;">
              <h3 style="color: #fff; margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem;">âš”ï¸ ê¸°ë³¸ í¸ì„± ëˆ„ì  <span style="color:#888; font-size:0.9rem;">(ìµœëŒ€ 7ëª…)</span></h3>
              ${renderKeywords(activeKeywords, true)}
            </div>
            <div class="support-panel">
              <h3 style="color: #aaa; margin-top: 0; margin-bottom: 0.5rem; font-size: 1.1rem;">
                ğŸª‘ 8ì¸ ì´ìƒ í™•ì¥ í¸ì„± <span style="font-size: 0.75rem; background: #333; padding: 0.2rem 0.5rem; border-radius: 4px; color: #eab308; margin-left: 0.5rem; vertical-align: middle;">ğŸ” ë§ˆìš°ìŠ¤ ì˜¤ë²„</span>
              </h3>
              <p style="color: #666; font-size: 0.85rem; margin: 0;">ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¤ 8~12ëª… í¸ì„± ì‹œì˜ <b>ëˆ„ì  í•©ê³„</b>ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
              <div class="support-tooltip">
                ${deck.length > 7 ? tooltipHTML : '<div style="color:#555; text-align:center;">8ëª… ì´ìƒ í¸ì„± ì‹œ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>'}
              </div>
            </div>
          </div>
        `;

        statusDiv.innerHTML = finalHTML;
      }
    </script>
  </body>
</html>